---
title: "Pittfalls when using @"
description: |
  A short description of the post.
author:
  - name: Gustav Delius
    url: {}
date: 08-08-2021
output:
  distill::distill_article:
    self_contained: false
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This blog post was written with mizer version 2.2.1

```{r}
library(mizer)
packageVersion("mizer")
```

As you will know, all the parameters describing a mizer model are contained in
an object of class MizerParams. Such an object has many slots holding the
information about the model. There are often two ways of accessing these slots.
One involves the use of the @ symbol, the other uses a dedicated function. I
would advocate always using the dedicated function and to avoid the use of @ in
your code. In this blog post I will explain why.

Throughout we will use the `NS_params` example MizerParams object in our 
examples.

```{r}
library(mizer)
params <- NS_params
```


## Species parameters

Let's start with the `species_params` data frame. You can get it in two ways,
both giving identical results:

```{r}
# Using function
sp <- species_params(params)
# Using @
spa <- params@species_params
# These are identical
identical(sp, spa)
```

The fact that these are identical is not surprising if you look at the code
for the `species_params()` function:

```{r}
species_params
```

The function actually only contains one statement, which accesses the
`species_params` slot using the @ notation.

The difference between the two notations becomes apparent only when you want to
make a change to the species parameters. Let's assume we want to change the `h`
parameter for the first species in our example model. It currently has the value

```{r}
species_params(params)$h[1]
```

As you know, this parameter `h` is used to calculate the maximum intake rate
$h(w)$ as a power-law function of size: $h(w) = h w^n$. So for example the
maximum intake rate at the smallest size is

```{r}
getMaxIntakeRate(params)[1, 1]
```

Now let's increase the value of the `h` parameter using the @ notation:

```{r}
params@species_params$h[1] <- 20
```

If we look at the maximum intake rate, we see that it has not changed:

```{r}
getMaxIntakeRate(params)[1, 1]
```

All we have done is change the value in the species parameter data frame, but
this did not trigger a recalculation of the maximum intake rate. We should 
instead have used

```{r}
species_params(params)$h[1] <- 20
```

This does indeed change the maximum intake rate:

```{r}
getMaxIntakeRate(params)[1, 1]
```

This behaviour is clear if we look at the code:

```{r}
`species_params<-`
```

So three things actually happen when you change a species parameter via the
setter function: 

1. Your new value is checked for validity
2. Your new value is saved in the `species_params` slot
3. The other slots in the MizerParams object are updated by calling `setParams()`.


## Gear parameters

Similar comments apply to the gear parameters. You can get the current 
gear parameters in two equivalent ways:

```{r}
# Using function
gp <- gear_params(params)
# Using @
gpa <- params@gear_params
# These are identical
identical(gp, gpa)
```

But if you want to actually change the selectivity or catchability by
changing the gear parameters you need to use the functional form. 
Here is the current `gear_params` data frame in the example model:

```{r}
gear_params(params)
```

If, for example, we want to reduce the catchability of Sprat with the Industrial
gear to 0.8 we would do

```{r}
gear_params(params)$catchability[1] <- 0.8
```

Note that changing gear parameters in the `species_params` data frame will
__not__ have the desired effect. You need to change them in the `gear_params`
data frame.


## Resource parameters

Not surprisingly, the same applies to the resource parameters. You should
access them with

```{r}
resource_params(params)
```

and change them with, for example,

```{r}
resource_params(params)$r_pp <- 4
```


When you look at the code defining the mizer functions, you will see lots of
@ signs. Here is a very simple example: the function `getMaxIntakeRate()` that
returns an array (species x size) containing the maximum rate at which the fish
of different species at different sizes can take in food.

```{r}
getMaxIntakeRate
```

We see that the function is extremely simple, consisting of the single 
statement

```{r eval=FALSE}
params@intake_max
```

This accesses a slot called `params@intake_max` of the MizerParams object
`params`. No calculation has to be done to determine the rates, because these
calculations are done when the MizerParams object is set up and then they are
stored in that `params@intake_max` slot. That is important to allow mizer quick
access to these rates when it runs simulations.

So there are two ways for you to get at the array of maximum intake rates. You
can either use the `getMaxIntakeRate()` function or you can access the
`params@intake_max` slot, and these give identical results:

```{r}
identical(getMaxIntakeRate(NS_params), NS_params@intake_max)
```

Similarly, there are two ways of changing the maximum intake rates. If
for example we wanted to create a new model where everyone has double the 
maximum intake rate, we could either do

```{r}
params1 <- setMaxIntakeRate(NS_params, 
                            intake_max = 2 * getMaxIntakeRate(NS_params))
```

or

```{r}
params2 <- NS_params
params2@intake_max <- 2 * NS_params@intake_max
```

```{r}
compareParams(params1, params2)
```


# Meaning of @ syntax
```{r}

```
